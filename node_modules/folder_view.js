var events = require('events');
var fs = require('fs');
var path = require('path');
var jade = require('jade');
var util = require('util');
var mime = require('mime');

// Template engine
var gen_files_view = jade.compile([
	'- each file in files',
	'  tr.file(data-path="#{file.path}", data-toggle="context") ',
	'    td',
	'      .icon',
	'        img(src="icons/#{file.type}.png")',
	'      .name.detail #{file.name}',
	'    td.detail.cap #{file.type}',
	'    td.detail #{file.type}',
].join('\n'));

// Our type
function Folder(jquery_element) {
	events.EventEmitter.call(this);
	this.element = jquery_element;


	var self = this;
	// Click on blank
	this.element.parent().on('click', function() {
		$('#context_dropdown').hide();
		self.element.find('.focus').removeClass('focus');
	});
	// Click on file
	this.element.delegate('.file', 'click', function(e) {
		currentFocus = 'files';
		self.element.find('.focus').removeClass('focus');
		$(this).addClass('focus');
		$('#context_dropdown').hide();
		e.stopPropagation();
	});
	// Double click on file
	this.element.delegate('.file', 'dblclick', function() {
		currentFocus = 'files';
		var file_path = $(this).attr('data-path');
		self.emit('navigate', file_path, mime.stat(file_path));
	});

	this.element.delegate('.file', 'contextmenu', function(e) {
		self.element.find('.focus').removeClass('focus');
		$(this).addClass('focus');

		currentFocus = 'contextmenu';
		var pos = $(this).offset();

		var $context_dropdown = $('#context_dropdown');
		$context_dropdown.show();
		$context_dropdown.offset({
			top: pos.top,
			left: pos.left
		});
		$context_dropdown.attr('data-path', $(this).attr('data-path'));

		// TODO
		// 1. hide on scroll etc.
		e.stopPropagation();
	});
}

util.inherits(Folder, events.EventEmitter);

Folder.prototype.open = function(dir) {
	var self = this;
	fs.readdir(dir, function(error, files) {
		if (error) {
			console.log(error);
			return;
		}
		var name = '';
		try {
			var out = [];
			for (var i = 0; i < files.length; ++i) {
				name = path.join(dir, files[i]);
				var s = fs.statSync(name);
				files[i] = mime.stat(name);
			}
		} catch (e) {
			console.log(e.stack);
		}

		var view = gen_files_view({
			files: files
		});
		self.element.html(view);
	});
};

exports.Folder = Folder;
