var events = require('events');
var fs = require('fs');
var path = require('path');
var jade = require('jade');
var util = require('util');
var mime = require('mime');

// Template engine
var gen_files_view = jade.compile([
	'- each file in files',
	'  tr.file(data-path="#{file.path}", data-toggle="context") ',
	'    td',
	'      .icon',
	'        img(src="icons/#{file.type}.png")',
	'      .name.detail #{file.name}',
	'    td.detail #{file.type}',
].join('\n'));

// Our type
function Folder(jquery_element) {
	events.EventEmitter.call(this);
	this.element = jquery_element;


	var self = this;
	// Click on blank
	this.element.parent().on('click', function() {
		$('#context_dropdown').hide();
		self.element.find('.focus').removeClass('focus');
	});
	// Click on file
	this.element.delegate('.file', 'click', function(e) {
		self.element.find('.focus').removeClass('focus');
		$(this).addClass('focus');
		$('#context_dropdown').hide();
		// position if clicked too close to bottom/right border TODO
		e.stopPropagation();
	});
	// Double click on file
	this.element.delegate('.file', 'dblclick', function() {
		var file_path = $(this).attr('data-path');
		self.emit('navigate', file_path, mime.stat(file_path));
	});

	// this.element.delegate('.file', 'keydown', function(e) { });

	this.element.delegate('.file', 'contextmenu', function(e) {
		self.element.find('.focus').removeClass('focus');
		var pos = $(this).offset();

		$(this).addClass('focus');
		$('#context_dropdown').show();
		$('#context_dropdown').offset({
			top: pos.top,
			left: pos.left
		});
		// TODO
		// 1. hide on scroll etc.
		e.stopPropagation();
	});
}

util.inherits(Folder, events.EventEmitter);

Folder.prototype.open = function(dir) {
	var self = this;
	fs.readdir(dir, function(error, files) {
		if (error) {
			console.log(error);
			window.alert(error);
			return;
		}

		for (var i = 0; i < files.length; ++i) {
			files[i] = mime.stat(path.join(dir, files[i]));
			console.log(JSON.stringify(files[i]));
			// console.log(fs.statSync(files[i]));
			// console.log(JSON.stringify(files[i]));
		}

		var view = gen_files_view({
			files: files
		});
		self.element.html(view);
	});
};

exports.Folder = Folder;
